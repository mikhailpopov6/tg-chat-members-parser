#!/usr/bin/env python3
"""
Enhanced Telegram Bot for Channel Members Parser
Beautiful interface with rich formatting and advanced features
"""

import asyncio
import logging
import sys
import datetime
import os
import json
from typing import Optional, List, Dict, Any
from telethon import TelegramClient
from telethon.tl.functions.channels import GetParticipantsRequest, GetFullChannelRequest
from telethon.tl.types import ChannelParticipantsSearch
import pandas as pd
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, BotCommand
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes, MessageHandler, filters
from telegram.constants import ParseMode

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('telegram_bot.log'),
        logging.StreamHandler(sys.stdout)
    ]
)
logger = logging.getLogger(__name__)

# Import configuration
try:
    from config_local import API_ID, API_HASH, PHONE_NUMBER, SESSION_NAME
    logger.info("Using local configuration")
except ImportError:
    from config import API_ID, API_HASH, PHONE_NUMBER, SESSION_NAME
    logger.info("Using environment variables configuration")

# Bot configuration
BOT_TOKEN = os.getenv('BOT_TOKEN', 'YOUR_BOT_TOKEN_HERE')

class EnhancedTelegramBot:
    def __init__(self):
        self.client = None
        self.active_parsers = {}
        
    async def start_telegram_client(self):
        """Initialize Telegram client"""
        try:
            self.client = TelegramClient(SESSION_NAME, API_ID, API_HASH)
            await self.client.start(phone=PHONE_NUMBER)
            
            if not await self.client.is_user_authorized():
                logger.error("Telegram client authentication failed")
                return False
                
            logger.info("Telegram client started successfully")
            return True
        except Exception as e:
            logger.error(f"Failed to start Telegram client: {str(e)}")
            return False

    def create_welcome_message(self) -> str:
        """Create beautiful welcome message"""
        return """
üéØ **Telegram Channel Members Parser Bot**

–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø–∞—Ä—Å–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ Telegram –∫–∞–Ω–∞–ª–æ–≤!

‚ú® **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
‚Ä¢ üìä –ü–∞—Ä—Å–∏–Ω–≥ –¥–æ **95%+** —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–∞–Ω–∞–ª–∞
‚Ä¢ üìÅ –≠–∫—Å–ø–æ—Ä—Ç –≤ **Excel** —Å –∫—Ä–∞—Å–∏–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º  
‚Ä¢ üîç **–£–º–Ω—ã–π –ø–æ–∏—Å–∫** –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
‚Ä¢ üìà **–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
‚Ä¢ üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è** –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
‚Ä¢ ‚ö° **–ë—ã—Å—Ç—Ä–∞—è** —Ä–∞–±–æ—Ç–∞ —Å –±–æ–ª—å—à–∏–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏

üöÄ **–ù–∞—á–Ω–∏—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!**
        """

    def create_channel_info_message(self, channel_info: Dict[str, Any]) -> str:
        """Create beautiful channel info message"""
        megagroup_icon = "üîó" if channel_info['is_megagroup'] else "üì¢"
        participants_count = f"{channel_info['participants_count']:,}"
        
        return f"""
{megagroup_icon} **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–Ω–∞–ª–µ**

üìù **–ù–∞–∑–≤–∞–Ω–∏–µ:** `{channel_info['title']}`
üë• **–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:** `{participants_count}`
üè∑Ô∏è **Username:** `@{channel_info['username'] or '–ù–µ —É–∫–∞–∑–∞–Ω'}`
üîß **–¢–∏–ø:** `{'–°—É–ø–µ—Ä–≥—Ä—É–ø–ø–∞' if channel_info['is_megagroup'] else '–ö–∞–Ω–∞–ª'}`

‚ö° **–ì–æ—Ç–æ–≤ –∫ –ø–∞—Ä—Å–∏–Ω–≥—É!**
        """

    def create_parsing_progress_message(self, pattern: str, progress: float, found: int) -> str:
        """Create parsing progress message"""
        progress_bar = self.create_progress_bar(progress)
        
        return f"""
üîÑ **–ü–∞—Ä—Å–∏–Ω–≥ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...**

üîç **–¢–µ–∫—É—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω:** `{pattern}`
üìä **–ü—Ä–æ–≥—Ä–µ—Å—Å:** {progress_bar} `{progress:.1f}%`
üë• **–ù–∞–π–¥–µ–Ω–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:** `{found:,}`

‚è≥ *–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...*
        """

    def create_progress_bar(self, progress: float, length: int = 10) -> str:
        """Create visual progress bar"""
        filled = int(progress / 100 * length)
        bar = "‚ñà" * filled + "‚ñë" * (length - filled)
        return f"`{bar}`"

    def create_results_message(self, participants: List, channel_info: Dict[str, Any]) -> str:
        """Create beautiful results message"""
        total_found = len(participants)
        total_expected = channel_info['participants_count']
        coverage = (total_found / total_expected * 100) if total_expected > 0 else 0
        
        # Calculate statistics
        bots_count = sum(1 for p in participants if p.bot)
        verified_count = sum(1 for p in participants if p.verified)
        premium_count = sum(1 for p in participants if p.premium)
        
        return f"""
‚úÖ **–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!**

üìä **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
‚Ä¢ üë• **–ù–∞–π–¥–µ–Ω–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:** `{total_found:,}`
‚Ä¢ üìà **–ü–æ–∫—Ä—ã—Ç–∏–µ:** `{coverage:.1f}%`
‚Ä¢ ü§ñ **–ë–æ—Ç–æ–≤:** `{bots_count:,}`
‚Ä¢ ‚úÖ **–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö:** `{verified_count:,}`
‚Ä¢ ‚≠ê **Premium:** `{premium_count:,}`

üìÅ **–°–æ–∑–¥–∞—é Excel —Ñ–∞–π–ª...**
        """

    def create_excel_export(self, participants: List, channel_title: str) -> str:
        """Create enhanced Excel export with beautiful formatting"""
        try:
            # Prepare data
            data = []
            for participant in participants:
                data.append({
                    'ID': participant.id,
                    'Username': participant.username or '–ù–µ —É–∫–∞–∑–∞–Ω',
                    '–ò–º—è': participant.first_name or '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                    '–§–∞–º–∏–ª–∏—è': participant.last_name or '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                    '–¢–µ–ª–µ—Ñ–æ–Ω': participant.phone or '–ù–µ —É–∫–∞–∑–∞–Ω',
                    '–ë–æ—Ç': 'ü§ñ –î–∞' if participant.bot else 'üë§ –ù–µ—Ç',
                    '–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω': '‚úÖ –î–∞' if participant.verified else '‚ùå –ù–µ—Ç',
                    'Premium': '‚≠ê –î–∞' if participant.premium else '‚ùå –ù–µ—Ç',
                    '–î–∞—Ç–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞': datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                })
            
            # Create DataFrame
            df = pd.DataFrame(data)
            
            # Create filename
            safe_title = "".join(c for c in channel_title if c.isalnum() or c in (' ', '-', '_')).rstrip()
            timestamp = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')
            filename = f"{safe_title}_{timestamp}.xlsx"
            
            # Save to Excel with formatting
            with pd.ExcelWriter(filename, engine='openpyxl') as writer:
                df.to_excel(writer, sheet_name='–£—á–∞—Å—Ç–Ω–∏–∫–∏', index=False)
                
                # Get workbook and worksheet
                workbook = writer.book
                worksheet = writer.sheets['–£—á–∞—Å—Ç–Ω–∏–∫–∏']
                
                # Auto-adjust column widths
                for column in worksheet.columns:
                    max_length = 0
                    column_letter = column[0].column_letter
                    for cell in column:
                        try:
                            if len(str(cell.value)) > max_length:
                                max_length = len(str(cell.value))
                        except:
                            pass
                    adjusted_width = min(max_length + 2, 50)
                    worksheet.column_dimensions[column_letter].width = adjusted_width
            
            return filename
        except Exception as e:
            logger.error(f"Error creating Excel export: {str(e)}")
            return None

    async def parse_channel_members_enhanced(self, channel_entity, user_id: int, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Enhanced parsing with real-time updates"""
        try:
            search_patterns = [''] + list('abcdefghijklmnopqrstuvwxyz') + list('0123456789')
            
            all_participants = []
            unique_participants = set()
            total_patterns = len(search_patterns)
            
            # Initial progress message
            progress_msg = await update.message.reply_text("üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞...")
            
            for i, pattern in enumerate(search_patterns):
                # Update progress
                progress = (i / total_patterns) * 100
                participants = await self.get_subscribers_by_search(channel_entity, pattern)
                
                # Add only unique participants
                new_participants = []
                for participant in participants:
                    if participant.id not in unique_participants:
                        unique_participants.add(participant.id)
                        new_participants.append(participant)
                
                all_participants.extend(new_participants)
                
                # Update progress message every 5 patterns
                if i % 5 == 0 or i == total_patterns - 1:
                    progress_text = self.create_parsing_progress_message(
                        pattern, progress, len(all_participants)
                    )
                    await progress_msg.edit_text(progress_text, parse_mode=ParseMode.MARKDOWN)
                
                await asyncio.sleep(0.3)
            
            return {
                'participants': all_participants,
                'total_found': len(all_participants),
                'success': True,
                'progress_msg': progress_msg
            }
            
        except Exception as e:
            logger.error(f"Error parsing channel members: {str(e)}")
            return {'success': False, 'error': str(e)}

    async def get_subscribers_by_search(self, channel_entity, search_pattern: str) -> List:
        """Get subscribers using search pattern"""
        participants = []
        offset = 0
        limit = 200
        
        while True:
            try:
                response = await self.client(GetParticipantsRequest(
                    channel=channel_entity,
                    filter=ChannelParticipantsSearch(search_pattern),
                    offset=offset,
                    limit=limit,
                    hash=0
                ))
                
                if not response.users:
                    break
                    
                participants.extend(response.users)
                offset += len(response.users)
                
                if len(response.users) < limit:
                    break
                    
                await asyncio.sleep(0.2)
                
            except Exception as e:
                logger.error(f"Error in search pattern '{search_pattern}': {str(e)}")
                break
        
        return participants

# Bot handlers
async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle /start command"""
    bot = EnhancedTelegramBot()
    welcome_text = bot.create_welcome_message()
    
    keyboard = [
        [InlineKeyboardButton("üîç –ü–∞—Ä—Å–∏—Ç—å –∫–∞–Ω–∞–ª", callback_data="parse_channel")],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="stats"),
         InlineKeyboardButton("‚ùì –°–ø—Ä–∞–≤–∫–∞", callback_data="help")],
        [InlineKeyboardButton("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data="settings")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(welcome_text, reply_markup=reply_markup, parse_mode=ParseMode.MARKDOWN)

async def parse_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle /parse command"""
    text = """
üîç **–ü–∞—Ä—Å–∏–Ω–≥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–∞–Ω–∞–ª–∞**

–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞–Ω–∞–ª –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.

**üìã –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:**
‚Ä¢ `https://t.me/channel_name`
‚Ä¢ `@channel_name`  
‚Ä¢ `t.me/channel_name`

**‚ö†Ô∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
‚Ä¢ –í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å **–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º** –∫–∞–Ω–∞–ª–∞
‚Ä¢ –ö–∞–Ω–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–ø—É–±–ª–∏—á–Ω—ã–º** –∏–ª–∏ —É –≤–∞—Å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

**üì§ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞–Ω–∞–ª:**
    """
    
    await update.message.reply_text(text, parse_mode=ParseMode.MARKDOWN)
    context.user_data['waiting_for_channel'] = True

async def handle_channel_link(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle channel link input with enhanced processing"""
    if not context.user_data.get('waiting_for_channel', False):
        return
    
    channel_link = update.message.text.strip()
    user_id = update.message.from_user.id
    
    # Clear waiting state
    context.user_data['waiting_for_channel'] = False
    
    # Show processing message
    processing_msg = await update.message.reply_text("üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram API...")
    
    try:
        # Initialize bot
        bot = EnhancedTelegramBot()
        
        # Start Telegram client
        if not await bot.start_telegram_client():
            await processing_msg.edit_text("‚ùå **–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Telegram API**\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API –∫–ª—é—á–µ–π.")
            return
        
        # Get channel info
        await processing_msg.edit_text("üîç –ü–æ–ª—É—á–∞—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–Ω–∞–ª–µ...")
        channel_info = await bot.get_channel_info(channel_link)
        
        if not channel_info:
            await processing_msg.edit_text("‚ùå **–ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞**\n\n–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:\n‚Ä¢ –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞\n‚Ä¢ –í—ã —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∫–∞–Ω–∞–ª–∞")
            await bot.client.disconnect()
            return
        
        # Show channel info
        info_text = bot.create_channel_info_message(channel_info)
        await processing_msg.edit_text(info_text, parse_mode=ParseMode.MARKDOWN)
        
        # Parse members with progress updates
        result = await bot.parse_channel_members_enhanced(channel_info['entity'], user_id, update, context)
        
        if not result['success']:
            await processing_msg.edit_text(f"‚ùå **–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:** `{result['error']}`")
            await bot.client.disconnect()
            return
        
        participants = result['participants']
        progress_msg = result['progress_msg']
        
        # Show results
        results_text = bot.create_results_message(participants, channel_info)
        await progress_msg.edit_text(results_text, parse_mode=ParseMode.MARKDOWN)
        
        # Create Excel export
        excel_file = bot.create_excel_export(participants, channel_info['title'])
        
        if not excel_file:
            await progress_msg.edit_text("‚ùå **–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Excel —Ñ–∞–π–ª–∞**")
            await bot.client.disconnect()
            return
        
        # Send Excel file
        with open(excel_file, 'rb') as file:
            await context.bot.send_document(
                chat_id=update.effective_chat.id,
                document=file,
                filename=excel_file,
                caption=f"üìä **–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–∞–Ω–∞–ª–∞ '{channel_info['title']}'**\n\n"
                       f"üë• **–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ:** `{len(participants):,}` —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤\n"
                       f"üìà **–ü–æ–∫—Ä—ã—Ç–∏–µ:** `{(len(participants) / channel_info['participants_count'] * 100):.1f}%`\n"
                       f"üìÖ **–î–∞—Ç–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:** `{datetime.datetime.now().strftime('%d.%m.%Y %H:%M')}`",
                parse_mode=ParseMode.MARKDOWN
            )
        
        # Cleanup
        os.remove(excel_file)
        await bot.client.disconnect()
        
        # Show completion message
        keyboard = [
            [InlineKeyboardButton("üîç –ü–∞—Ä—Å–∏—Ç—å –¥—Ä—É–≥–æ–π –∫–∞–Ω–∞–ª", callback_data="parse_channel")],
            [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="stats")],
            [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="start")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await progress_msg.edit_text(
            "üéâ **–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!**\n\nüìÅ Excel —Ñ–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.\n\n–ß—Ç–æ –¥–µ–ª–∞–µ–º –¥–∞–ª—å—à–µ?",
            reply_markup=reply_markup,
            parse_mode=ParseMode.MARKDOWN
        )
        
    except Exception as e:
        logger.error(f"Error in channel parsing: {str(e)}")
        await processing_msg.edit_text(f"‚ùå **–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:** `{str(e)}`")

async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle button callbacks"""
    query = update.callback_query
    await query.answer()
    
    if query.data == "parse_channel":
        await parse_command(update, context)
    elif query.data == "start":
        await start_command(update, context)
    elif query.data == "stats":
        await query.edit_message_text("üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**\n\n–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...", parse_mode=ParseMode.MARKDOWN)
    elif query.data == "help":
        await query.edit_message_text("‚ùì **–°–ø—Ä–∞–≤–∫–∞**\n\n–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...", parse_mode=ParseMode.MARKDOWN)
    elif query.data == "settings":
        await query.edit_message_text("‚öôÔ∏è **–ù–∞—Å—Ç—Ä–æ–π–∫–∏**\n\n–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...", parse_mode=ParseMode.MARKDOWN)

async def setup_bot_commands(application: Application):
    """Setup bot commands menu"""
    commands = [
        BotCommand("start", "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"),
        BotCommand("parse", "üîç –ü–∞—Ä—Å–∏—Ç—å –∫–∞–Ω–∞–ª"),
    ]
    await application.bot.set_my_commands(commands)

def main():
    """Main function to run the enhanced bot"""
    if BOT_TOKEN == 'YOUR_BOT_TOKEN_HERE':
        logger.error("Please set BOT_TOKEN environment variable or update the code")
        return
    
    # Create application
    application = Application.builder().token(BOT_TOKEN).build()
    
    # Add handlers
    application.add_handler(CommandHandler("start", start_command))
    application.add_handler(CommandHandler("parse", parse_command))
    application.add_handler(CallbackQueryHandler(button_callback))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_channel_link))
    
    # Setup bot commands
    application.post_init = setup_bot_commands
    
    logger.info("Starting Enhanced Telegram bot...")
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()
